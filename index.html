<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Excel Auto Processor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
    box-sizing: border-box;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
}

body {
    margin: 0;
    min-height: 100vh;
    background: linear-gradient(135deg, #e8eefc, #f4f6f8);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
}

.container {
    background: #ffffff;
    width: 100%;
    max-width: 520px;
    padding: 24px;
    border-radius: 14px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    text-align: center;
}

.container h2 {
    margin-bottom: 10px;
    color: #1f2937;
    font-size: clamp(20px, 5vw, 24px);
    line-height: 1.3;
}

.container p {
    margin-bottom: 25px;
    color: #6b7280;
    font-size: clamp(13px, 3.5vw, 15px);
    line-height: 1.5;
}

.file-box {
    border: 2px dashed #c7d2fe;
    padding: 20px;
    border-radius: 10px;
    background: #f9fafb;
    margin-bottom: 25px;
    transition: border-color 0.3s ease;
}

.file-box:hover {
    border-color: #2563eb;
}

.file-box input[type="file"] {
    width: 100%;
    padding: 12px;
    font-size: 14px;
    border-radius: 8px;
    cursor: pointer;
}

button {
    width: 100%;
    padding: clamp(12px, 3.5vw, 16px);
    font-size: clamp(14px, 4vw, 16px);
    font-weight: 600;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: #2563eb;
    color: #ffffff;
    transition: background 0.25s ease, transform 0.1s ease;
    position: relative;
    overflow: hidden;
}

button:hover {
    background: #1e40af;
}

button:active {
    transform: scale(0.98);
}

button:after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

button:focus:not(:active)::after {
    animation: ripple 1s ease-out;
}

@keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.5;
    }
    100% {
        transform: scale(20, 20);
        opacity: 0;
    }
}

.footer {
    margin-top: 20px;
    font-size: clamp(11px, 3vw, 13px);
    color: #9ca3af;
    line-height: 1.4;
}

/* Responsive adjustments */
@media (max-width: 480px) {
    .container {
        padding: 20px 16px;
        border-radius: 12px;
    }
    
    .file-box {
        padding: 16px;
        margin-bottom: 20px;
    }
    
    .file-box input[type="file"] {
        padding: 10px;
        font-size: 13px;
    }
    
    button {
        padding: 14px;
    }
}

@media (max-width: 360px) {
    .container {
        padding: 16px 12px;
    }
    
    .file-box {
        padding: 12px;
    }
    
    .container h2 {
        font-size: 18px;
    }
}

/* Tablet and larger mobile adjustments */
@media (min-width: 768px) and (max-width: 1024px) {
    .container {
        max-width: 600px;
        padding: 32px 28px;
    }
    
    .container h2 {
        font-size: 26px;
    }
    
    .container p {
        font-size: 16px;
    }
}

/* Loading indicator */
.loading {
    display: none;
    margin-top: 20px;
    font-size: 14px;
    color: #2563eb;
}

.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(37, 99, 235, 0.3);
    border-radius: 50%;
    border-top-color: #2563eb;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Success message */
.success-message {
    display: none;
    margin-top: 16px;
    padding: 12px;
    background-color: #d1fae5;
    color: #065f46;
    border-radius: 8px;
    font-size: 14px;
    border-left: 4px solid #10b981;
}

/* Error message */
.error-message {
    display: none;
    margin-top: 16px;
    padding: 12px;
    background-color: #fee2e2;
    color: #991b1b;
    border-radius: 8px;
    font-size: 14px;
    border-left: 4px solid #ef4444;
}
</style>
</head>
<body>
<div class="container">
    <h2>Excel Auto Processor</h2>
    <p>Upload Excel → Auto Process → Download CSV</p>
    <div class="file-box">
        <input type="file" id="fileInput" accept=".xlsx,.csv">
    </div>
    <button onclick="processExcel()" id="processBtn"> Process & Download CSV</button>   
    <div class="loading" id="loadingIndicator">
        <div class="spinner"></div> Processing your file...</div>    
    <div class="success-message" id="successMessage">File processed successfully! Download should start automatically.</div>    
    <div class="error-message" id="errorMessage">An error occurred. Please check your file and try again.</div>
    <div class="footer">Supports .xlsx and .csv files | Optimized for all devices</div>
</div>

<script>
function processExcel() {
    const file = document.getElementById("fileInput").files[0];
    const processBtn = document.getElementById("processBtn");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const successMessage = document.getElementById("successMessage");
    const errorMessage = document.getElementById("errorMessage");
    successMessage.style.display = 'none';
    errorMessage.style.display = 'none';
    
    if (!file) {
        errorMessage.textContent = "Please upload an Excel file";
        errorMessage.style.display = 'block';
        return;
    }
    
    // Show loading indicator
    loadingIndicator.style.display = 'block';
    processBtn.disabled = true;
    processBtn.textContent = "Processing...";
    processBtn.style.opacity = "0.7";
    
    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

            const output = [];

            rows.forEach(row => {
                let category = (row.Category || "").toString().trim();
                const first = category.charAt(0);
                const last  = category.slice(-1);

                /* ---------- Gender ---------- */
                let gender = "";
                if (first === "G") gender = "All";
                if (first === "L") gender = "Female";

                /* Remove first letter G / L */
                if (first === "G" || first === "L") {
                    category = category.substring(1);
                }

                /* ---------- Alloted ---------- */
                let alloted = "";
                if (last === "O" || last === "H") {
                    alloted = last;
                    category = category.slice(0, -1);
                }

                /* ---------- SpecialKota (S) ---------- */
                let specialKota = "";
                let upperCat = category.toUpperCase();
                const isException = (upperCat === "EWS" || upperCat === "TFWS");

                if (!isException && upperCat.endsWith("S")) {
                    specialKota = "Yes";
                    category = category.slice(0, -1);
                }

                /* ---------- SpecialReservation ---------- */
                let specialReservation = "";
                upperCat = category.toUpperCase();

                if (upperCat.startsWith("DEFR")) {
                    specialReservation = "DEFR";
                    category = category.substring(4);
                }
                else if (upperCat.startsWith("PWD")) {
                    specialReservation = "PWD";
                    category = category.substring(3);
                }
                else if (upperCat.startsWith("DEF")) {
                    specialReservation = "DEF";
                    category = category.substring(3);
                }
                else if (upperCat.includes("ORPHAN")) {
                    specialReservation = "ORPHAN";
                    // do NOT remove ORPHAN from category
                }

                output.push({
                    ...row,
                    Gender: gender,
                    Category: category,
                    SpecialKota: specialKota,
                    SpecialReservation: specialReservation,
                    Alloted: alloted
                });
            });

            // Hide loading indicator
            loadingIndicator.style.display = 'none';
            
            // Show success message
            successMessage.style.display = 'block';
            
            // Download the CSV
            downloadCSV(output);
            
        } catch (error) {
            console.error("Processing error:", error);
            
            // Hide loading indicator
            loadingIndicator.style.display = 'none';
            
            // Show error message
            errorMessage.textContent = "Error processing file: " + error.message;
            errorMessage.style.display = 'block';
        } finally {
            // Reset button state
            processBtn.disabled = false;
            processBtn.textContent = "Process & Download CSV";
            processBtn.style.opacity = "1";
        }
    };

    reader.onerror = function() {
        // Hide loading indicator
        loadingIndicator.style.display = 'none';
        
        // Show error message
        errorMessage.textContent = "Error reading file. Please try again.";
        errorMessage.style.display = 'block';
        
        // Reset button state
        processBtn.disabled = false;
        processBtn.textContent = "Process & Download CSV";
        processBtn.style.opacity = "1";
    };

    reader.readAsArrayBuffer(file);
}

function downloadCSV(data) {
    if (!data.length) {
        document.getElementById("errorMessage").textContent = "No data found in the file";
        document.getElementById("errorMessage").style.display = 'block';
        return;
    }

    try {
        const headers = Object.keys(data[0]).join(",");
        const rows = data.map(r =>
            Object.values(r).map(v => `"${v}"`).join(",")
        );

        const csv = [headers, ...rows].join("\n");
        const blob = new Blob([csv], { type: "text/csv" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "processed_data.csv";
        
        // Auto-click to download
        link.click();
        
        // Clean up
        setTimeout(() => URL.revokeObjectURL(link.href), 100);
        
    } catch (error) {
        console.error("Download error:", error);
        document.getElementById("errorMessage").textContent = "Error generating CSV file";
        document.getElementById("errorMessage").style.display = 'block';
    }
}

// Add some interactivity to the file input
document.getElementById('fileInput').addEventListener('change', function(e) {
    const fileName = e.target.files[0] ? e.target.files[0].name : 'No file chosen';
    
    // Reset messages when new file is selected
    document.getElementById("successMessage").style.display = 'none';
    document.getElementById("errorMessage").style.display = 'none';
});
</script>

</body>
</html>
